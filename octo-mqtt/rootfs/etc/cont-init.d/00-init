#!/usr/bin/with-contenv bash
# ==============================================================================
# Initialize the add-on
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Load AppArmor profile if available
if [ -f /etc/apparmor.d/octo-mqtt ]; then
    echo "Loading AppArmor profile..."
    apparmor_parser -r /etc/apparmor.d/octo-mqtt || echo "Warning: Could not load AppArmor profile"
fi

# Create data directory if it doesn't exist
if [ ! -d /data ]; then
    mkdir -p /data
fi

# Set proper permissions
chown -R root:root /data
chmod -R 755 /data

# Ensure configuration directory exists
if [ ! -d /data/octo-mqtt ]; then
    mkdir -p /data/octo-mqtt
fi

# Copy default configuration if it doesn't exist
if [ ! -f /data/options.json ]; then
    echo "Creating default configuration..."
    cat > /data/options.json << 'EOF'
{
  "bleProxies": [
    {
      "host": "192.168.1.100",
      "port": 6053,
      "password": "",
      "encryptionKey": "",
      "expectedServerName": ""
    }
  ],
  "octoDevices": [],
  "mqtt_host": null,
  "mqtt_port": null,
  "mqtt_user": null,
  "mqtt_password": null,
  "target_mac": null,
  "target_pin": null,
  "enable_mac_filtering": true,
  "enable_pin_filtering": true,
  "scan_duration": 30000,
  "scan_interval": 5000,
  "target_device_name": null,
  "ble_scan_parameters": {
    "duration": 30000,
    "interval": 100,
    "window": 50,
    "active": true
  }
}
EOF
fi

echo "Add-on initialization complete" 